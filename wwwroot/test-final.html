<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Pocket Board Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/images/icon-192x192.png">
    <style>
        .test-result {
            transition: all 0.3s ease;
        }
        .test-passed {
            background-color: #10B981;
            color: white;
        }
        .test-failed {
            background-color: #EF4444;
            color: white;
        }
        .test-warning {
            background-color: #F59E0B;
            color: white;
        }
        .test-info {
            background-color: #3B82F6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Test Final - Pocket Board Finance</h1>
            <p class="text-gray-600 mb-6">Tests complets de toutes les fonctionnalit√©s de l'application</p>
            
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="runAllTests" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    Lancer tous les tests
                </button>
                <button id="testAuth" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    Test Authentification
                </button>
                <button id="testAPI" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    Test API Backend
                </button>
                <button id="testPWA" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700">
                    Test PWA
                </button>
                <button id="testResponsive" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                    Test Responsive
                </button>
            </div>

            <div id="testResults" class="space-y-4">
                <!-- Les r√©sultats des tests appara√Ætront ici -->
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Statut de l'Application</h2>
            <div id="appStatus" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Le statut de l'application appara√Ætra ici -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 left-4 sm:left-auto z-50"></div>

    <!-- Scripts -->
    <script src="/js/api-config.js"></script>
    <script src="/js/api-service.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/pwa.js"></script>

    <script>
        class FinalTester {
            constructor() {
                this.results = [];
                this.setupEventListeners();
                this.checkAppStatus();
            }

            setupEventListeners() {
                document.getElementById('runAllTests').addEventListener('click', () => this.runAllTests());
                document.getElementById('testAuth').addEventListener('click', () => this.testAuthentication());
                document.getElementById('testAPI').addEventListener('click', () => this.testAPI());
                document.getElementById('testPWA').addEventListener('click', () => this.testPWA());
                document.getElementById('testResponsive').addEventListener('click', () => this.testResponsive());
            }

            async runAllTests() {
                this.clearResults();
                this.addResult('info', 'D√©marrage des tests complets...');
                
                await this.testAuthentication();
                await this.testAPI();
                await this.testPWA();
                await this.testResponsive();
                await this.testIntegration();
                
                this.addResult('info', 'Tests termin√©s!');
                this.showSummary();
            }

            async testAuthentication() {
                this.addResult('info', 'üîê Test de l\'authentification...');
                
                try {
                    // Test 1: V√©rifier les scripts d'auth
                    if (typeof AuthManager !== 'undefined') {
                        this.addResult('passed', '‚úÖ AuthManager charg√© correctement');
                    } else {
                        this.addResult('failed', '‚ùå AuthManager non disponible');
                        return;
                    }

                    // Test 2: V√©rifier le localStorage
                    const token = localStorage.getItem('pf_token');
                    if (token) {
                        this.addResult('passed', '‚úÖ Token d\'authentification pr√©sent');
                    } else {
                        this.addResult('warning', '‚ö†Ô∏è Aucun token d\'authentification (normal si non connect√©)');
                    }

                    // Test 3: V√©rifier la configuration API
                    if (window.apiConfig && window.apiService) {
                        this.addResult('passed', '‚úÖ Configuration API charg√©e');
                    } else {
                        this.addResult('failed', '‚ùå Configuration API manquante');
                    }

                } catch (error) {
                    this.addResult('failed', `‚ùå Erreur test auth: ${error.message}`);
                }
            }

            async testAPI() {
                this.addResult('info', 'üåê Test de l\'API Backend...');
                
                try {
                    if (!window.apiService) {
                        this.addResult('failed', '‚ùå API Service non disponible');
                        return;
                    }

                    // Test de sant√© de l'API
                    try {
                        const health = await window.apiService.get('/health');
                        this.addResult('passed', '‚úÖ API Backend accessible');
                    } catch (error) {
                        this.addResult('warning', `‚ö†Ô∏è API Backend non accessible: ${error.message}`);
                    }

                    // Test des endpoints principaux
                    const endpoints = [
                        '/accounts',
                        '/transactions',
                        '/statistics'
                    ];

                    for (const endpoint of endpoints) {
                        try {
                            await window.apiService.get(endpoint);
                            this.addResult('passed', `‚úÖ Endpoint ${endpoint} accessible`);
                        } catch (error) {
                            this.addResult('warning', `‚ö†Ô∏è Endpoint ${endpoint} non accessible: ${error.message}`);
                        }
                    }

                } catch (error) {
                    this.addResult('failed', `‚ùå Erreur test API: ${error.message}`);
                }
            }

            async testPWA() {
                this.addResult('info', 'üì± Test des fonctionnalit√©s PWA...');
                
                try {
                    // Test 1: Manifest
                    const manifest = await fetch('/manifest.json');
                    if (manifest.ok) {
                        this.addResult('passed', '‚úÖ Manifest PWA charg√©');
                    } else {
                        this.addResult('failed', '‚ùå Manifest PWA non accessible');
                    }

                    // Test 2: Service Worker
                    if ('serviceWorker' in navigator) {
                        this.addResult('passed', '‚úÖ Service Worker support√© par le navigateur');
                        
                        try {
                            const registration = await navigator.serviceWorker.getRegistration();
                            if (registration) {
                                this.addResult('passed', '‚úÖ Service Worker enregistr√©');
                            } else {
                                this.addResult('warning', '‚ö†Ô∏è Service Worker non enregistr√©');
                            }
                        } catch (error) {
                            this.addResult('warning', '‚ö†Ô∏è Erreur Service Worker: ' + error.message);
                        }
                    } else {
                        this.addResult('failed', '‚ùå Service Worker non support√©');
                    }

                    // Test 3: Mode hors ligne
                    if (navigator.onLine) {
                        this.addResult('passed', '‚úÖ Application en ligne');
                    } else {
                        this.addResult('warning', '‚ö†Ô∏è Application en mode hors ligne');
                    }

                    // Test 4: Notifications
                    if ('Notification' in window) {
                        this.addResult('passed', '‚úÖ Notifications support√©es');
                        
                        if (Notification.permission === 'granted') {
                            this.addResult('passed', '‚úÖ Permission notifications accord√©e');
                        } else {
                            this.addResult('warning', '‚ö†Ô∏è Permission notifications non accord√©e');
                        }
                    } else {
                        this.addResult('failed', '‚ùå Notifications non support√©es');
                    }

                } catch (error) {
                    this.addResult('failed', `‚ùå Erreur test PWA: ${error.message}`);
                }
            }

            async testResponsive() {
                this.addResult('info', 'üìê Test du design responsive...');
                
                try {
                    // Test 1: Viewport
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (viewport) {
                        this.addResult('passed', '‚úÖ Meta viewport configur√©');
                    } else {
                        this.addResult('failed', '‚ùå Meta viewport manquant');
                    }

                    // Test 2: Tailwind CSS
                    if (document.querySelector('script[src*="tailwindcss"]')) {
                        this.addResult('passed', '‚úÖ Tailwind CSS charg√©');
                    } else {
                        this.addResult('failed', '‚ùå Tailwind CSS non charg√©');
                    }

                    // Test 3: Classes responsive
                    const responsiveElements = document.querySelectorAll('[class*="sm:"], [class*="md:"], [class*="lg:"]');
                    if (responsiveElements.length > 0) {
                        this.addResult('passed', `‚úÖ ${responsiveElements.length} √©l√©ments avec classes responsive`);
                    } else {
                        this.addResult('warning', '‚ö†Ô∏è Aucune classe responsive d√©tect√©e');
                    }

                    // Test 4: Largeur d'√©cran
                    const screenWidth = window.innerWidth;
                    this.addResult('info', `üìè Largeur d'√©cran: ${screenWidth}px`);
                    
                    if (screenWidth < 640) {
                        this.addResult('info', 'üì± Mode mobile d√©tect√©');
                    } else if (screenWidth < 768) {
                        this.addResult('info', 'üì± Mode tablette d√©tect√©');
                    } else {
                        this.addResult('info', 'üíª Mode desktop d√©tect√©');
                    }

                } catch (error) {
                    this.addResult('failed', `‚ùå Erreur test responsive: ${error.message}`);
                }
            }

            async testIntegration() {
                this.addResult('info', 'üîó Test de l\'int√©gration compl√®te...');
                
                try {
                    // Test 1: Scripts charg√©s
                    const requiredScripts = [
                        'api-config.js',
                        'api-service.js',
                        'auth.js',
                        'backend-integration.js'
                    ];

                    for (const script of requiredScripts) {
                        const scriptElement = document.querySelector(`script[src*="${script}"]`);
                        if (scriptElement) {
                            this.addResult('passed', `‚úÖ Script ${script} charg√©`);
                        } else {
                            this.addResult('failed', `‚ùå Script ${script} manquant`);
                        }
                    }

                    // Test 2: Variables globales
                    const globalVars = ['apiConfig', 'apiService', 'AuthManager'];
                    for (const varName of globalVars) {
                        if (window[varName]) {
                            this.addResult('passed', `‚úÖ Variable globale ${varName} disponible`);
                        } else {
                            this.addResult('failed', `‚ùå Variable globale ${varName} manquante`);
                        }
                    }

                    // Test 3: Int√©gration backend
                    if (window.backendIntegration) {
                        this.addResult('passed', '‚úÖ BackendIntegration initialis√©');
                    } else {
                        this.addResult('warning', '‚ö†Ô∏è BackendIntegration non initialis√©');
                    }

                } catch (error) {
                    this.addResult('failed', `‚ùå Erreur test int√©gration: ${error.message}`);
                }
            }

            checkAppStatus() {
                const statusContainer = document.getElementById('appStatus');
                
                const statusItems = [
                    {
                        title: 'Authentification',
                        status: typeof AuthManager !== 'undefined' ? 'active' : 'inactive',
                        description: 'Syst√®me d\'authentification JWT'
                    },
                    {
                        title: 'API Backend',
                        status: window.apiService ? 'active' : 'inactive',
                        description: 'Service d\'int√©gration API'
                    },
                    {
                        title: 'PWA',
                        status: 'serviceWorker' in navigator ? 'active' : 'inactive',
                        description: 'Application Progressive Web'
                    },
                    {
                        title: 'Responsive',
                        status: document.querySelector('meta[name="viewport"]') ? 'active' : 'inactive',
                        description: 'Design adaptatif'
                    },
                    {
                        title: 'Int√©gration',
                        status: window.backendIntegration ? 'active' : 'inactive',
                        description: 'Synchronisation backend'
                    },
                    {
                        title: 'Connexion',
                        status: navigator.onLine ? 'online' : 'offline',
                        description: '√âtat de la connexion'
                    }
                ];

                statusContainer.innerHTML = statusItems.map(item => `
                    <div class="p-4 rounded-lg border ${this.getStatusColor(item.status)}">
                        <h3 class="font-semibold text-lg">${item.title}</h3>
                        <p class="text-sm opacity-75">${item.description}</p>
                        <div class="mt-2">
                            <span class="inline-block w-3 h-3 rounded-full ${this.getStatusDotColor(item.status)}"></span>
                            <span class="ml-2 text-sm capitalize">${item.status}</span>
                        </div>
                    </div>
                `).join('');
            }

            getStatusColor(status) {
                const colors = {
                    active: 'bg-green-50 border-green-200',
                    inactive: 'bg-red-50 border-red-200',
                    online: 'bg-blue-50 border-blue-200',
                    offline: 'bg-yellow-50 border-yellow-200'
                };
                return colors[status] || 'bg-gray-50 border-gray-200';
            }

            getStatusDotColor(status) {
                const colors = {
                    active: 'bg-green-500',
                    inactive: 'bg-red-500',
                    online: 'bg-blue-500',
                    offline: 'bg-yellow-500'
                };
                return colors[status] || 'bg-gray-500';
            }

            addResult(type, message) {
                this.results.push({ type, message, timestamp: new Date() });
                this.displayResult(type, message);
            }

            displayResult(type, message) {
                const resultsContainer = document.getElementById('testResults');
                const resultElement = document.createElement('div');
                resultElement.className = `test-result p-4 rounded-lg ${type === 'passed' ? 'test-passed' : type === 'failed' ? 'test-failed' : type === 'warning' ? 'test-warning' : 'test-info'}`;
                resultElement.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">${message}</span>
                        <span class="text-xs opacity-75 ml-auto">${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
                resultsContainer.appendChild(resultElement);
            }

            clearResults() {
                this.results = [];
                document.getElementById('testResults').innerHTML = '';
            }

            showSummary() {
                const passed = this.results.filter(r => r.type === 'passed').length;
                const failed = this.results.filter(r => r.type === 'failed').length;
                const warnings = this.results.filter(r => r.type === 'warning').length;
                const total = this.results.length;

                this.addResult('info', `üìä R√©sum√©: ${passed} r√©ussis, ${failed} √©checs, ${warnings} avertissements sur ${total} tests`);
            }
        }

        // Initialisation du testeur
        document.addEventListener('DOMContentLoaded', () => {
            window.finalTester = new FinalTester();
        });
    </script>
</body>
</html>